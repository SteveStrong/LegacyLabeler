@page "/legacy-labeler"
@page "/legacy-labeler/{DocumentId?}"
@rendermode InteractiveServer

<PageTitle>Legacy Labeler</PageTitle>

<h1>Legacy Labeler</h1>

@if (currentDocument != null)
{
    <div class="alert alert-info mb-3">
        <strong>Reviewing:</strong> @currentDocument.OriginalFilename 
        <span class="badge bg-secondary ms-2">@(currentDocumentIndex + 1) of @allDocuments.Count</span>
    </div>
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>Document Viewer</h4>
                @if (currentDocument != null)
                {
                    <small class="text-muted">@currentDocument.OriginalFilename</small>
                }
            </div>
            <div class="card-body">
                @if (currentDocument != null)
                {
                    <div class="document-viewer border rounded" style="height: 500px; overflow: auto;">
                        @if (currentDocument.FileType == "pdf")
                        {
                            <embed src="@GetDocumentUrl()" 
                                   type="application/pdf" 
                                   width="100%" 
                                   height="100%" 
                                   style="border: none;">
                            <p class="text-center p-4">
                                <a href="@GetDocumentUrl()" target="_blank" class="btn btn-primary">
                                    <i class="bi bi-download"></i> Open PDF in New Tab
                                </a>
                            </p>
                        }
                        else if (IsImageFile(currentDocument.FileType))
                        {
                            <img src="@GetDocumentUrl()" 
                                 alt="@currentDocument.OriginalFilename" 
                                 class="img-fluid mx-auto d-block" 
                                 style="max-height: 480px; cursor: zoom-in;"
                                 @onclick="ToggleImageZoom">
                        }
                        else
                        {
                            <div class="text-center p-4">
                                <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
                                <p>Unsupported file type: @currentDocument.FileType</p>
                                <a href="@GetDocumentUrl()" target="_blank" class="btn btn-outline-primary">
                                    Open File
                                </a>
                            </div>
                        }
                    </div>
                }
                else if (string.IsNullOrEmpty(DocumentId))
                {
                    <div class="text-center p-4">
                        <p class="text-muted">No document selected</p>
                        <a href="/document-browser" class="btn btn-primary">
                            <i class="bi bi-folder"></i> Browse Documents
                        </a>
                    </div>
                }
                else
                {
                    <div class="text-center p-4">
                        <p class="text-muted">Document not found</p>
                        <a href="/document-browser" class="btn btn-primary">
                            <i class="bi bi-folder"></i> Back to Browser
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-mic"></i> Voice Capture</h4>
            </div>
            <div class="card-body">
                <!-- Speech to Text Button -->
                <div class="mb-3 text-center">
                    <RadzenSpeechToTextButton Change="@OnSpeechCaptured" 
                                              Text="ðŸŽ¤ Start Recording"
                                              StopText="â¹ï¸ Stop Recording"
                                              class="btn btn-primary btn-lg w-100" />
                </div>
                
                <!-- Description Text Area -->
                <div class="mb-3">
                    <label for="documentDescription" class="form-label">Description:</label>
                    <RadzenTextArea @bind-Value="@description" 
                                   Change="@(args => OnDescriptionChange(args))"
                                   Placeholder="Voice transcription will appear here..."
                                   Rows="8"
                                   class="w-100" />
                </div>
                
                <!-- Category Selection -->
                <div class="mb-3">
                    <label for="documentCategory" class="form-label">Category:</label>
                    <RadzenDropDown @bind-Value="@selectedCategory" 
                                   Data="@categories" 
                                   Placeholder="Select category..." 
                                   class="w-100" />
                </div>
                
                <!-- Keywords -->
                <div class="mb-3">
                    <label for="documentTags" class="form-label">Keywords:</label>
                    <RadzenTextBox @bind-Value="@keywords" 
                                  Placeholder="Enter keywords separated by commas"
                                  class="w-100" />
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-success" @onclick="SaveAndNext" disabled="@(currentDocument == null || string.IsNullOrEmpty(description))">
                        <i class="bi bi-check-circle"></i> Save & Next Document
                    </button>
                    <button class="btn btn-primary" @onclick="SaveDescription" disabled="@(currentDocument == null || string.IsNullOrEmpty(description))">
                        <i class="bi bi-floppy"></i> Save Description
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" @onclick="LoadPreviousDocument" disabled="@(allDocuments.Count <= 1)">
                            <i class="bi bi-arrow-left"></i> Previous
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="LoadNextDocument" disabled="@(allDocuments.Count <= 1)">
                            <i class="bi bi-arrow-right"></i> Next
                        </button>
                    </div>
                    <button class="btn btn-outline-secondary" @onclick="ClearDescription">
                        <i class="bi bi-eraser"></i> Clear Description
                    </button>
                </div>
                
                <!-- Activity Log -->
                @if (activityLog.Any())
                {
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="bi bi-clock-history"></i> Activity Log</h6>
                        </div>
                        <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                            @foreach (var log in activityLog.TakeLast(5))
                            {
                                <small class="text-muted d-block">@log.Timestamp.ToString("HH:mm:ss") - @log.Message</small>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        
        @if (savedDescriptions.Any())
        {
            <div class="card mt-3">
                <div class="card-header">
                    <h5>Recent Descriptions</h5>
                </div>
                <div class="card-body">
                    @foreach (var saved in savedDescriptions.Take(3))
                    {
                        <div class="border-bottom pb-2 mb-2">
                            <small class="text-muted">@saved.DocumentName - @saved.Timestamp.ToString("MM/dd HH:mm")</small>
                            <div class="small">@saved.Description</div>
                            @if (!string.IsNullOrEmpty(saved.Category))
                            {
                                <span class="badge bg-secondary">@saved.Category</span>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>